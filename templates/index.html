<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur de Réponses Ouvertes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-chat-dots-fill me-2"></i>
                    Analyseur de Réponses Ouvertes
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#configModal">
                                <i class="bi bi-gear-fill"></i> Configuration
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="row">
            <!-- Panneau latéral gauche -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Workflow</h5>
                    </div>
                    <div class="card-body">
                        <!-- Stepper vertical -->
                        <div class="bs-stepper vertical" id="workflow-stepper">
                            <div class="bs-stepper-header">
                                <div class="step" data-target="#import-part">
                                    <button type="button" class="step-trigger">
                                        <span class="bs-stepper-circle">1</span>
                                        <span class="bs-stepper-label">Importation</span>
                                    </button>
                                </div>
                                <div class="line"></div>
                                <div class="step" data-target="#analyze-part">
                                    <button type="button" class="step-trigger">
                                        <span class="bs-stepper-circle">2</span>
                                        <span class="bs-stepper-label">Analyse</span>
                                    </button>
                                </div>
                                <div class="line"></div>
                                <div class="step" data-target="#tags-part">
                                    <button type="button" class="step-trigger">
                                        <span class="bs-stepper-circle">3</span>
                                        <span class="bs-stepper-label">Tags</span>
                                    </button>
                                </div>
                                <div class="line"></div>
                                <div class="step" data-target="#summaries-part">
                                    <button type="button" class="step-trigger">
                                        <span class="bs-stepper-circle">4</span>
                                        <span class="bs-stepper-label">Synthèses</span>
                                    </button>
                                </div>
                                <div class="line"></div>
                                <div class="step" data-target="#data-part">
                                    <button type="button" class="step-trigger">
                                        <span class="bs-stepper-circle">5</span>
                                        <span class="bs-stepper-label">Données</span>
                                    </button>
                                </div>
                                <div class="line"></div>
                                <div class="step" data-target="#export-part">
                                    <button type="button" class="step-trigger">
                                        <span class="bs-stepper-circle">6</span>
                                        <span class="bs-stepper-label">Exportation</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panneau d'importation -->
                <div class="card mt-3" id="import-panel">
                    <div class="card-header">
                        <h5 class="card-title">Importation</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="file" class="form-label">Fichier de données</label>
                                <input type="file" class="form-control" id="file" name="file" accept=".csv,.json,.txt">
                                <div class="form-text">Formats acceptés: CSV, JSON, TXT</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Importer</button>
                        </form>
                        
                        <hr>
                        
                        <div id="fileInfo" class="d-none">
                            <h6>Aperçu des données</h6>
                            <p><strong>Nombre de lignes:</strong> <span id="rowCount">0</span></p>
                            <p><strong>Colonnes:</strong> <span id="columnList">-</span></p>
                            
                            <div id="columnSelectContainer" class="mb-3 d-none">
                                <label for="columnSelect" class="form-label">Colonne à analyser</label>
                                <select class="form-select" id="columnSelect">
                                    <!-- Options générées dynamiquement -->
                                </select>
                            </div>
                            
                            <button id="processBtn" class="btn btn-success">Analyser les réponses</button>
                        </div>
                    </div>
                </div>
                
                <!-- Panneau d'exportation -->
                <div class="card mt-3 d-none" id="export-panel">
                    <div class="card-header">
                        <h5 class="card-title">Exportation</h5>
                    </div>
                    <div class="card-body">
                        <p>Exporter les résultats d'analyse</p>
                        <div class="d-grid gap-2">
                            <button id="exportCsvBtn" class="btn btn-outline-primary" disabled>CSV</button>
                            <button id="exportJsonBtn" class="btn btn-outline-primary" disabled>JSON</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panneau principal pour les résultats -->
            <div class="col-md-9">
                <div class="card mb-4">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="resultTabs">
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#importTab">Importation</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#analyzeTab">Analyse</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tagsTab">Tags</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#summariesTab">Synthèses</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#dataTab">Données</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#exportTab">Exportation</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#testMistralTab">Tester Mistral</a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <!-- Onglet Importation -->
                            <div class="tab-pane fade" id="importTab">
                                <div class="text-center py-4">
                                    <i class="bi bi-cloud-upload fs-1 text-primary"></i>
                                    <h3 class="mt-3">Importation de données</h3>
                                    <p class="text-muted">Utilisez le panneau de gauche pour importer votre fichier de données</p>
                                    <p>Formats acceptés: CSV, JSON, TXT</p>
                                </div>
                            </div>
                            
                            <!-- Onglet Analyse -->
                            <div class="tab-pane fade" id="analyzeTab">
                                <div id="loadingAnalysis" class="d-none">
                                    <div class="d-flex justify-content-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Chargement...</span>
                                        </div>
                                    </div>
                                    <p class="text-center mt-2">Analyse en cours...</p>
                                </div>
                                
                                <div id="analyzeContent" class="d-none">
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle-fill me-2"></i>
                                        Analyse terminée avec succès !
                                    </div>
                                    <p>L'analyse de vos données est terminée. Vous pouvez maintenant explorer les résultats dans les onglets suivants.</p>
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <button class="btn btn-outline-secondary prev-tab-btn">Précédent</button>
                                        <button class="btn btn-primary next-tab-btn">Voir les Tags</button>
                                    </div>
                                </div>
                                
                                <div id="noAnalysisContent" class="text-center">
                                    <p class="text-muted">Importez un fichier puis cliquez sur "Analyser les réponses" pour lancer l'analyse</p>
                                </div>
                            </div>

                            <!-- Onglet Tags -->
                            <div class="tab-pane fade" id="tagsTab">
                                <div id="loadingTags" class="d-none">
                                    <div class="d-flex justify-content-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Chargement...</span>
                                        </div>
                                    </div>
                                    <p class="text-center mt-2">Analyse des tags en cours...</p>
                                </div>
                                
                                <div id="tagsContent" class="d-none">
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-header">
                                                    <h6 class="card-title">Distribution des tags</h6>
                                                </div>
                                                <div class="card-body">
                                                    <canvas id="tagsChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-header">
                                                    <h6 class="card-title">Tags normalisés</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="normalizedTagsList" class="list-group">
                                                        <!-- Liste générée dynamiquement -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-3">
                                        <button class="btn btn-outline-secondary prev-tab-btn">Précédent</button>
                                        <button class="btn btn-primary next-tab-btn">Voir les Synthèses</button>
                                    </div>
                                </div>
                                
                                <div id="noTagsContent" class="text-center d-none">
                                    <p class="text-muted">Importez et analysez un fichier pour voir les tags extraits</p>
                                </div>
                            </div>
                            
                            <!-- Onglet Synthèses -->
                            <div class="tab-pane fade" id="summariesTab">
                                <div id="loadingSummaries" class="d-none">
                                    <div class="d-flex justify-content-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Chargement...</span>
                                        </div>
                                    </div>
                                    <p class="text-center mt-2">Génération des synthèses en cours...</p>
                                </div>
                                
                                <div id="summariesContent" class="d-none">
                                    <div class="mb-3">
                                        <select class="form-select" id="tagSelector">
                                            <option value="">Sélectionnez un tag...</option>
                                            <!-- Options générées dynamiquement -->
                                        </select>
                                    </div>
                                    
                                    <div id="tagSummaryContainer" class="d-none">
                                        <div class="card mb-3">
                                            <div class="card-header">
                                                <h6 class="card-title">Synthèse du tag: <span id="currentTagName"></span></h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="tagSummaryContent"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title">Réponses associées</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="tagResponsesList" class="list-group">
                                                    <!-- Liste générée dynamiquement -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-3">
                                        <button class="btn btn-outline-secondary prev-tab-btn">Précédent</button>
                                        <button class="btn btn-primary next-tab-btn">Voir les Données</button>
                                    </div>
                                </div>
                                
                                <div id="noSummariesContent" class="text-center d-none">
                                    <p class="text-muted">Importez et analysez un fichier pour voir les synthèses</p>
                                </div>
                            </div>
                            
                            <!-- Onglet Données -->
                            <div class="tab-pane fade" id="dataTab">
                                <div id="dataContent" class="d-none">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="dataTable">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Réponse</th>
                                                    <th>Tags</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Données générées dynamiquement -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between mt-3">
                                        <button class="btn btn-outline-secondary prev-tab-btn">Précédent</button>
                                        <button class="btn btn-primary next-tab-btn">Exporter les résultats</button>
                                    </div>
                                </div>
                                
                                <div id="noDataContent" class="text-center d-none">
                                    <p class="text-muted">Importez un fichier pour voir les données</p>
                                </div>
                            </div>

                            <!-- Onglet Exportation -->
                            <div class="tab-pane fade" id="exportTab">
                                <div class="text-center py-4">
                                    <i class="bi bi-download fs-1 text-success"></i>
                                    <h3 class="mt-3">Exporter vos résultats</h3>
                                    <p class="text-muted">Choisissez le format d'exportation souhaité</p>
                                    
                                    <div class="row justify-content-center mt-4">
                                        <div class="col-md-6">
                                            <div class="d-grid gap-3">
                                                <button id="exportCsvBtnMain" class="btn btn-lg btn-outline-primary" disabled>
                                                    <i class="bi bi-filetype-csv me-2"></i> Exporter en CSV
                                                </button>
                                                <button id="exportJsonBtnMain" class="btn btn-lg btn-outline-primary" disabled>
                                                    <i class="bi bi-filetype-json me-2"></i> Exporter en JSON
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-start mt-5">
                                        <button class="btn btn-outline-secondary prev-tab-btn">Précédent</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Onglet Test Mistral -->
                            <div class="tab-pane fade show active" id="testMistralTab">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h5 class="mb-0">Analyser une réponse avec Mistral AI</h5>
                                            </div>
                                            <div class="card-body">
                                                <form id="mistralTestForm">
                                                    <div class="mb-3">
                                                        <label for="mistralResponseText" class="form-label">Réponse à analyser:</label>
                                                        <textarea class="form-control" id="mistralResponseText" rows="4" placeholder="Saisissez la réponse à analyser ici..."></textarea>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="mistralCustomPrompt" class="form-label">Prompt personnalisé (optionnel):</label>
                                                        <textarea class="form-control" id="mistralCustomPrompt" rows="3" placeholder="Laissez vide pour utiliser le prompt par défaut"></textarea>
                                                    </div>
                                                    <div class="d-grid">
                                                        <button type="submit" class="btn btn-primary">
                                                            <i class="bi bi-robot me-2"></i>Analyser avec Mistral
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                        
                                        <div class="card mt-4 d-none" id="mistralResultsCard">
                                            <div class="card-header bg-success text-white">
                                                <h5 class="mb-0">Résultats de l'analyse</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <h5>Réponse originale:</h5>
                                                    <p id="mistralOriginalResponse" class="p-3 bg-light border rounded"></p>
                                                </div>
                                                <div>
                                                    <h5>Analyse:</h5>
                                                    <div id="mistralAnalysisResult" class="p-3 bg-light border rounded"></div>
                                                </div>
                                                <div class="mt-3">
                                                    <small class="text-muted">Modèle utilisé: <span id="mistralModelUsed"></span></small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Configuration -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configuration Mistral AI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="configForm">
                        <div class="mb-3">
                            <label for="model" class="form-label">Modèle Mistral</label>
                            <select class="form-select" id="model">
                                <option value="mistral-small-latest" {% if config.model == 'mistral-small-latest' %}selected{% endif %}>Mistral Small</option>
                                <option value="mistral-medium-latest" {% if config.model == 'mistral-medium-latest' %}selected{% endif %}>Mistral Medium</option>
                                <option value="mistral-large-latest" {% if config.model == 'mistral-large-latest' %}selected{% endif %}>Mistral Large</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="apiKey" class="form-label">Clé API Mistral</label>
                            <input type="password" class="form-control" id="apiKey" value="{{ config.api_key }}">
                            <div class="form-text">Votre clé API est stockée localement et via .env</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="endpoint" class="form-label">Point d'accès API</label>
                            <input type="text" class="form-control" id="endpoint" value="{{ config.endpoint }}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveConfigBtn">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bs-stepper@1.7.0/dist/js/bs-stepper.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html> 